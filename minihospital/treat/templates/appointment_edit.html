{% extends 'layout.html' %}
{% load static %}

{% block title %}
    profile
{% endblock %}
{% block head %}
<style>
    body{
        font-family: "Kanit", sans-serif;
        font-size: 16px;
    }
    
    .link{
        transition: transform 0.3s ease, color 0.3s ease;
        color: #494949;
    }

    .link:hover{
        color: #15CDCB;
        transform: scale(1.05);
    }

    .profile{
        background: linear-gradient(to right, #5280E2, #15CDCB);
        transition: transform 0.3s ease;
    }

    .profile:hover{
        transform: scale(0.95);
    }

    .personal{
        font-size: 48px;
        color: #3E5279;
    }

    .boxboxno{
        box-shadow: 0px 0px 30.2px 0px rgba(0, 0, 0, 0.25);
        border-radius: 20px;
    }

    .boxbox{
        box-shadow: 0px 0px 30.2px 0px rgba(0, 0, 0, 0.25);
        border-radius: 20px;
    }

    .boxbox:hover{
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        transform: scale(0.98);
        cursor: pointer;
    }

    .edit{
        background: linear-gradient(to right, #5280E2, #15CDCB);
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    }

    .edit:hover{
        transform: scale(0.95);
    }

    .name{
        color: #909090;
    }

    .name2{
        color: #494949;
    }

    .name3{
        color: #15CDCB;
    }

    .notyet{
        background-color: #E8374F;
        font-style: normal;
        font-weight: 400;
    }

    .already{
        background-color: #6ED655;
        font-style: normal;
        font-weight: 400;
    }

    .cancel {
        background-color: white; /* Inner background color */
        border-radius: 50px;
        border: 1px solid var(--Linear, #5280E2);
        background: var(--Linear, linear-gradient(90deg, #5280E2 0%, #15CDCB 100%));
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    }

    .cancel:hover {
        /* transform: scale(0.98); */
        background: linear-gradient(to right, #5280E2, #15CDCB);
        color: white; /* Set text color to white on hover */
        -webkit-background-clip: unset; /* Remove background clip on hover */
        -webkit-text-fill-color: unset; /* Remove text fill color on hover */
        /* font-weight: 400; */
    }

    .close{
        top: 270px;
        right: 400px;
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    }

    .close:hover {
        transform: scale(0.95);
    }

    .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        .modal-content {
            background-color: white; /* White background */
            padding: 20px; /* Padding */
            border-radius: 10px; /* Rounded corners */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); /* Shadow */
            width: 400px; /* Set width */
            max-width: 90%; /* Responsive */
            position: relative; /* Position relative for the close button */
        }

        .close {
            color: #aaa; /* Close button color */
            float: right; /* Positioning */
            font-size: 28px; /* Font size */
            font-weight: bold; /* Font weight */
            cursor: pointer; /* Pointer cursor */
        }

        .close:hover,
        .close:focus {
            color: black; /* Hover color */
        }

    .bin:hover{
        transform: scale(0.95);
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    }

</style>
{% endblock %}

{% block content %}
<div class="container mx-auto w-full px-36 pt-12 pb-20 fade-in">
    <h1 class="personal font-medium mb-14">ประวัติการรักษา</h1>

    {% for appointment in appointments %}
            <!-- กล่อง boxbox ที่ แสดงว่าได้รับการรักษาแล้ว -->
            <div class="boxbox bg-white p-12 fade-in flex items-center mb-10 relative" onclick="window.location.href='{% url 'treat:treatment-result' pk=appointment.pk %}';">
                <div class="flex items-center justify-between w-full">
                    <div class="flex-shrink-0">
                        <img src="{% static 'image/check-up.png'%}" alt="check-up" class="w-24 h-24 fade-in">
                    </div>
                    <div class="flex-grow mx-4">
                        <h2 class="name2 font-medium mb-1 flex items-center">หมายเลขนัดหมายที่ {{ appointment.id }}
                            {% if appointment.treat_count > 0 %}
                                <span class="ml-4 already text-white px-6 py-1 rounded-full">
                                    ได้รับการรักษาแล้ว
                                </span>
                            {% else %}
                                <span class="ml-4 bg-[#E8374F] text-white px-6 py-1 rounded-full">
                                    ยังไม่ได้รับการรักษา
                                </span>
                            {% endif %}
                        </h2>
                        <p class="name2 mb-1">วันที่นัดหมาย : {{ appointment.appointment_date|date:"d/m/Y" }}</p>
                        {% for treatment in treatments %}
                            {% if treatment.appointment == appointment %}
                                <p class="name2 mb-2">ผลวินิจฉัย: {{ treatment.diagnose }}</p>
                            {% endif %}
                        {% endfor %}
                        <p class="name3 font-medium">{{ appointment.doctor.user.first_name }} {{ appointment.doctor.user.last_name }}</p> 
                    </div>
                    <div>
                        <a href="#" class="text-xl p-3 px-12 font-medium hover:bg-[#15CDCB] duration-300 hover:scale-110 transition ease-in-out delay-150 bg-transparent border border-[#15CDCB] flex justify-center rounded-full items-center]">
                            ยกเลิกนัดหมาย
                         </a>
                    </div>
                </div>
            </div>
    {% endfor %}
    
    <!-- Pop-up Container -->
    <form method="post">
        {% csrf_token %}
        <!-- <div class="text-red-500 mb-4">
            {{ form.nonfield_errors }}
        </div> -->
        
        <!-- <div class="text-red-500 mb-4">
            {{ form.errors }}
        </div> -->
        <div id="popup" class="z-[101] fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
            <div class="p-10 bg-white rounded-[20px] shadow relative px-12">
                <div class="text-start text-[#3d5279] text-[32px] font-semibold">แก้ไขการนัดหมาย</div>
                <div class="text-start text-[#909090] text-base font-normal">กรุณาแก้ไขข้อมูลให้ถูกต้อง</div>
                <div class="text-red-500 mb-4">
                    {{ form.errors }}
                </div>
                <div class="flex space-x-12 mt-10 items-center">
                    <div class="w-[134px] h-[134px] bg-[#e1f6f5] rounded-full">
                        <img class="rounded-full" width="134" height="134" src="{{ doc.doctor_image.url }}" />
                    </div>

                    <div>
                        <div class="text-[#494949] text-base font-normal">ผู้ป่วย : {{ user.patient.prefix }} {{user.first_name}} {{user.last_name}}</div>
                        <div class="text-[#494949] text-base font-normal">แพทย์ : {{ doc.prefix }} {{ doc.user.first_name }} {{ doc.user.last_name }}</div>
                        <div class="text-[#494949] text-base font-normal">แผนก :
                            <div class="bg-[#d2e0ff] rounded-[30px] text-left text-[#6986c4] text-base font-normal py-1 px-5 inline-block">
                                {{ doc.department }}
                            </div>
                        </div>
                        <div class="text-[#494949] text-base font-normal flex items-center flex items-center space-x-5 my-5">
                            <div>วันที่นัดหมาย : </div>
                            {{form.appointment_date}}
                        </div>
                        <div class="text-[#494949] text-base font-normal flex items-center space-x-5">
                            <div>เวลานัดหมาย : </div>
                            {{form.appointment_time }}
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-10 mb-5 mx-10">
                    <button type="button" onclick="deleteAppointment({{user.id}}, {{app.id}})" class="text-xl p-3 px-12 font-medium hover:bg-[#15CDCB] duration-300 hover:scale-110 transition ease-in-out delay-150 bg-transparent border border-[#15CDCB] flex justify-center rounded-full items-center]">
                    ยกเลิกนัดหมาย
                    </button>

                    <script>
                        function deleteAppointment(user_id, app_id) {
                            const csrfToken = '{{ csrf_token }}'; // Get CSRF token
                            const url = `/hopelife/treatment/${user_id}/edit/${app_id}/`;
                    
                            fetch(url, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': csrfToken, // Include CSRF token in header
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => {
                                if (response.ok) {
                                    alert('นัดหมายถูกยกเลิกเรียบร้อยแล้ว');
                                    window.location.href = `/hopelife/treatment/${user_id}/`; // Use template literals correctly
                                } else {
                                    alert('ไม่สามารถยกเลิกนัดหมายได้');
                                }
                            })
                            .catch(error => console.error('Error:', error));
                        }
                    </script>

                    <button type="submit" class="bg-gradient-to-r p-3 px-5 from-[#5280e2] to-[#15cdcb] rounded-[50px] text-center text-white text-xl font-medium">
                        แก้ไขการนัดหมาย
                    </button>
                </div>

                <!-- ปุ่มปิด pop-up -->
                <a href="{% url 'treat:treatment-list' user.id %}">
                    <img onclick="togglePopup()" class="absolute top-3 right-3 w-10 h-10 cursor-pointer" src="{% static 'image/close.png' %}" />
                </a>
            </div>
        </div>
    </form>

    </div>

    <script>
        function togglePopup() {
            const popup = document.getElementById('popup');
            popup.classList.toggle('hidden'); // ซ่อนหรือแสดง popup
        }

        // ผูก event กับปุ่ม "จองคิวพบแพทย์"
        document.getElementById('edit').addEventListener('click', function(event) {
            event.preventDefault(); // ป้องกันการ submit ฟอร์มทันที
            togglePopup(); // แสดงหรือซ่อน pop-up
        });
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // เลือกทุกองค์ประกอบที่คุณต้องการให้เฟด
            const elements = document.querySelectorAll('.fade-in');

            // เพิ่มคลาสเพื่อทำให้เฟด
            setTimeout(() => {
                elements.forEach(element => {
                    element.classList.add('fade-in-active');
                });
            }, 100); // รอ 100ms ก่อนเริ่มเฟด
        });

        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('editAppointmentModal');
            const btn = document.getElementById('editAppointmentBtn');
            const span = document.getElementsByClassName('close')[0];

            // When the user clicks the button, open the modal
            btn.onclick = function () {
                modal.classList.remove('hidden');
            }

            // When the user clicks on <span> (x), close the modal
            span.onclick = function () {
                modal.classList.add('hidden');
            }

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.classList.add('hidden');
                }
            }
        });
    </script>
{% endblock %}