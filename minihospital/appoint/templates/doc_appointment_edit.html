{% extends 'layout.html' %}
{% load static %}

{% block title %}
    appointment
{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<div class="container-full flex flex-col justify-center items-center">

    <!-- <div class="container m-5 flex space-x-6 justify-start items-center">
        <div class="text-[#909090] text-[20px] font-normal">{{ previous }}</div>
        <img class="" width="14" height="14" src="{% static 'image/play-button.png' %}" />
        <div class="text-center text-[#909090] text-[20px] font-normal">{{doc.prefix}} {{doc.user.first_name}} {{doc.user.last_name}}</div>
    </div> -->

        <div class="container m-5 flex space-x-6 justify-center items-center p-5">

            <!-- ข้อมูลหมอ -->
            <div class="bg-white rounded-[20px] shadow w-[600px] p-10">
                <div class="flex space-x-4">
                    <div class="w-full h-auto mt-2">
                        <div class="text-start text-[#494949] text-lg font-normal">{{ start }} - {{ end }} น.</div>
                        <div class="text-[#494949] text-base font-normal">{{ doc.shift_day }}</div>
                        <div class="flex space-x-4 items-center">
                            <div class="text-start text-[#c7c7c7] text-base font-normal">สถานะ :</div>
                            {% if today_day in doc.day %}
                                <div class="bg-[#6ED655] rounded-full text-left text-white text-base font-[16px] py-1 px-5">ว่าง</div>
                            {% else %}
                                <div class="bg-[#d2e0ff] rounded-full text-left text-[#6986c4] text-base font-[16px] py-1 px-5">นอกเวลาทำการ</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="w-[100px] h-[100px] bg-[#e1f6f5] rounded-full flex-none">
                        <img class="rounded-full object-cover w-full h-full" src="{{ doc.doctor_image.url }}" />
                    </div>
                </div>
                <hr class="border-2 border-b-[#efefef] w-full mt-3 mb-5">
                <div class="text-start text-[#3d5279] text-[32px] font-semibold">{{doc.prefix}} {{doc.user.first_name}} {{doc.user.last_name}}</div>
                <div class="bg-[#d2e0ff] rounded-[30px] mt-3 mb-4 text-left text-[#6986c4] text-base font-normal py-1 px-5 inline-block">
                    {{ doc.department }}
                </div>
                <div class="text-[#909090] text-lg font-normal">{{ doc.description }} </div>
            </div>
            
            <!-- กรอกวันที่ต้องการนัด -->
            <div class="h-auto w-full flex flex-col items-center">
                <div class="w-full flex space-x-5 items-center justify-between">
                    <div class="text-center text-[#3d5279] text-[32px] font-semibold">นัดหมายแพทย์</div>
                    <div class="flex space-x-5 items-center">
                        <div class="w-[350px] flex items-center relative">
                            <input 
                                    type="text" 
                                    id="startDate"
                                    class="duration-300 transition ease-in-out delay-150 text-[16px] w-full rounded-full bg-[#EFEFEF] text-[#494949] px-5 py-3 pr-14 focus:outline-none focus:border-[#15cdcb] focus:ring-2 focus:ring-[#15cdcb]" 
                                    placeholder="dd/mm/yyyy" 
                                    oninput="updateDates()"
                                    value={{appointment_date_str}}
                                />
                            <img src="{% static 'image/greycalendar.png' %}" onclick="openDatePicker('startDate')" class="cursor-pointer absolute right-6" width="27" height="27">
                        </div>
                        <button onclick="sendLink()" class="hover:from-[#15cdcb] hover:to-[#15cdcb] bg-gradient-to-r from-[#5280e2] to-[#15cdcb] rounded-[50px] text-center text-white text-[16px] font-medium px-4  py-2">เลือกวัน</button>
                    </div>

                </div>
                <div class="w-full text-start text-[#909090] text-lg font-normal">กรุณาเลือกวันที่ต้องการ</div>
                
                <div class="flex justify-between items-center">
                    
                    <img width="50" height="50" src="{% static 'image\left-arrow (2).png' %}" class="hidden">
                    
                    <div id="dateGrid" class="grid grid-cols-7 grid-cols-1 gap-[26px] m-16">
                        {% for i in week %}
                            <div class="relative bg-[#E1F6F5] text-[#3E5279] rounded-[10px] flex flex-col justify-center items-center p-6">
                                <div id="day{{i}}" class="text-center text-lg font-normal"></div>
                                <div id="date{{i}}" class="text-center text-[32px] font-medium"></div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <img width="50" height="50" src="{% static 'image\left-arrow (2).png' %}" class="hidden rotate-180">
                    
                </div>
                
                
            </div>

            <!-- <script>
                function sendLink() {
                    // รับค่าจากฟิลด์ startDate
                    const input = document.getElementById('startDate').value;
                    
                    // ตรวจสอบว่า input มีค่า
                    if (!input) {
                        alert("กรุณากรอกวันที่ก่อนส่งลิงค์");
                        return;
                    }
                    
                    // แยกวันที่จากรูปแบบ dd/mm/yyyy
                    const parts = input.split('/');
                    if (parts.length !== 3) {
                        alert("รูปแบบวันที่ไม่ถูกต้อง กรุณากรอกวันที่ในรูปแบบ dd/mm/yyyy");
                        return;
                    }
                    
                    const day = parts[0];
                    const month = parts[1];
                    const year = parts[2];
            
                    // แปลงวันที่เป็นรูปแบบ Y-m-d
                    const formattedDate = `${year}-${month}-${day}`;
                    
                    // สร้าง URL ใหม่ (คุณสามารถกำหนดรูปแบบ URL ได้ตามที่ต้องการ)
                    const doctorId = "{{ doc.id }}";  // รับค่า doctor.id จาก Django หรือจะใช้ค่าอื่นที่คุณต้องการ
                    const newUrl = `/hopelife/doctor_appointment/${formattedDate}/`;  // เปลี่ยน URL ตามที่คุณต้องการ
            
                    // ตรวจสอบว่า URL ถูกต้องหรือไม่
                    console.log("New URL:", newUrl);
                    
                    // เปลี่ยนหน้าไปยัง URL ใหม่
                    window.location.href = newUrl;
                }
            </script> -->
            
        </div>
        
        <div class="container my-5 mx-20 flex justify-center items-center p-5 flex-col">
            <div class="text-start w-full text-[#3d5279] text-[32px] font-semibold" id="formattedDate"></div>
            <div class="text-[#909090] text-lg font-normal text-start w-full ">หากต้องการแก้ไขการนัดหมาย กรุณากดที่เวลาที่ต้องการแก้</div>

            <!-- เลือกเวลานัด  -->
            <div class="grid grid-cols-6 gap-2 my-16">
                {% for start_time, end_time, status in updated_times %}
                    {% if start_time|slice:":2" == "12" %}
                        {% if start_time == "12:00" %}
                            <div class="col-span-6 border-y-2 border-[#EBEBEB] py-3 px-5 text-center text-[#909090] text-lg font-normal">
                                ช่วงพักกลางวัน: 12:00 - 13:00 น.
                            </div>
                        {% endif %}
                    {% else %}

                            {% if status == "in_range" %}
                                <div class="time-slot bg-[#e1f6f5] rounded-[20px] flex space-x-3 py-3 px-5 cursor-pointer" data-start="{{ start_time }}">
                                    <div class="text-[#3d5279] text-lg font-normal">{{ start_time }}</div>
                                    <img class="" width="22" height="22" src="{% static 'image/arrow.png' %}" />
                                    <div class="text-[#3d5279] text-lg font-normal">{{ end_time }}</div>
                                </div>
                            {% else %}
                                <div class="bg-[#EBEBEB] rounded-[20px] flex space-x-3 py-3 px-5">
                                    <div class="text-[#C8C8C8] text-lg font-normal">{{ start_time }}</div>
                                    <img class="" width="22" height="22" src="{% static 'image/arrow.png' %}" />
                                    <div class="text-[#C8C8C8] text-lg font-normal">{{ end_time }}</div>
                                </div>
                            {% endif %}


                    {% endif %}
                {% endfor %}
            </div>
            
 
            <script>
                document.querySelectorAll('.time-slot').forEach(slot => {
                    slot.addEventListener('click', function() {
                        // ลบคลาสที่ active ออกจากช่องเวลาอื่น ๆ
                        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('bg-blue-200'));
                        
                        // เพิ่มคลาส active ให้กับช่องเวลาที่ถูกคลิก
                        this.classList.add('bg-blue-200');
                        
                        // เก็บค่าเวลาที่เลือก
                        const appointmentTime = this.getAttribute('data-start');
                        
                        // กำหนดค่าให้กับ input hidden ที่จะส่งไปกับ form
                        document.getElementById('appointment_time').value = appointmentTime;
                        document.getElementById('validation_time').innerText= "เวลานัดหมาย : " + appointmentTime;
                        
                        // แสดงผลเวลาเพื่อทดสอบ (optional)
                        console.log(`Selected appointment time: ${appointmentTime}`);
                        
                        // ส่งฟอร์มไปยัง server
                    });
                });
            </script>
            
            <!-- Pop-up Container -->
            <form method="post">
                {% csrf_token %}
                <div class="text-red-500 mb-4">
                    {{ form.nonfield_errors }}
                </div>
                
                <div class="text-red-500 mb-4">
                    {{ form.errors }}
                </div>
                <div id="popup" class="z-[101] fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
                    <div class="p-10 bg-white rounded-[20px] shadow relative px-12">
                        <div class="text-start text-[#3d5279] text-[32px] font-semibold">แก้ไขการนัดหมาย</div>
                        <div class="text-start text-[#909090] text-base font-normal">กรุณาแก้ไขข้อมูลให้ถูกต้อง</div>
                        <div class="text-red-500 mb-4">
                            {{ form.errors }}
                        </div>
                        <div class="flex space-x-12 mt-10 items-center">
                            <div class="w-[134px] h-[134px] bg-[#e1f6f5] rounded-full">
                                <img class="rounded-full" width="134" height="134" src="{{ app_patient.patient_image.url }}" />
                            </div>

                            <div>
                                <div class="text-[#494949] text-base font-normal">ผู้ป่วย : {{ app_patient.prefix }} {{app_patient }}</div>
                                <div class="text-[#494949] text-base font-normal">แพทย์ : {{ doc.prefix }} {{ doc.user.first_name }} {{ doc.user.last_name }}</div>
                                <div class="text-[#494949] text-base font-normal">แผนก :
                                    <div class="bg-[#d2e0ff] rounded-[30px] text-left text-[#6986c4] text-base font-normal py-1 px-5 inline-block">
                                        {{ doc.department }}
                                    </div>
                                </div>
                                <div class="text-[#494949] text-base font-normal flex items-center flex items-center space-x-5 my-5">
                                    <div>วันที่นัดหมาย : </div>
                                    {{form.appointment_date}}
                                </div>
                                <div class="text-[#494949] text-base font-normal flex items-center space-x-5">
                                    <div>เวลานัดหมาย : </div>
                                    {{form.appointment_time }}
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-10 mb-5 mx-10">
                            <button type="button" onclick="deleteAppointment('{{current_date}}', '{{appointment_time}}')" class="text-xl p-3 px-12 font-medium hover:bg-[#15CDCB] duration-300 hover:scale-110 transition ease-in-out delay-150 bg-transparent border border-[#15CDCB] flex justify-center rounded-full items-center]">
                               ยกเลิกนัดหมาย
                            </button>

                            <script>
                                function deleteAppointment(current_date, appointment_time) {
                                    const csrfToken = '{{ csrf_token }}'; // Get CSRF token
                                    const url = `/hopelife/doctor_appointment/{{current_date}}/${appointment_time}/edit/`;

                                    fetch(url, {
                                        method: 'DELETE',
                                        headers: {
                                            'X-CSRFToken': csrfToken, // Include CSRF token in header
                                            'Content-Type': 'application/json'
                                        }
                                    })
                                    .then(response => {
                                        if (response.ok) {
                                            alert('นัดหมายถูกยกเลิกเรียบร้อยแล้ว');
                                            window.location.href = '/hopelife/doctor_appointment/{{current_date}}/'; // Redirect after delete

                                        } else {
                                            alert('ไม่สามารถยกเลิกนัดหมายได้');
                                        }
                                    })
                                    .catch(error => console.error('Error:', error));
                                }
                            </script>

                            <button type="submit" class="bg-gradient-to-r p-3 px-5 from-[#5280e2] to-[#15cdcb] rounded-[50px] text-center text-white text-xl font-medium">
                                แก้ไขการนัดหมาย
                            </button>
                        </div>

                        <!-- ปุ่มปิด pop-up -->
                        <a href="{% url 'appoint:doc_appointment' current_date %}">
                            <img onclick="togglePopup()" class="absolute top-3 right-3 w-10 h-10 cursor-pointer" src="{% static 'image/close.png' %}" />
                        </a>
                    </div>
                </div>
            </form>

            <script>
                function togglePopup() {
                    const popup = document.getElementById('popup');
                    popup.classList.toggle('hidden'); // ซ่อนหรือแสดง popup
                }
            
                // ผูก event กับปุ่ม "จองคิวพบแพทย์"
                document.getElementById('edit').addEventListener('click', function(event) {
                    event.preventDefault(); // ป้องกันการ submit ฟอร์มทันที
                    togglePopup(); // แสดงหรือซ่อน pop-up
                });
            </script>
        
        </div>
        
    </form>
</div>

<script type="application/json" id="docDaysData">
    {{ doc_days_json }}
</script>
<script src="{% static 'js/dateInput.js' %}"></script>

{% endblock %}